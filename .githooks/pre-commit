#!/usr/bin/env bash
# Git Worktree Utils - Pre-commit Hook
# Runs shellcheck and basic validation

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# Get the list of shell scripts to check
SHELL_FILES=(
    "git-worktree-utils.sh"
    "git-worktree-utils-help.sh"
    "install.sh"
    "uninstall.sh"
    "test.sh"
)

# Check if shellcheck is available
if command -v shellcheck >/dev/null 2>&1; then
    echo -e "${YELLOW}→ Running shellcheck...${NC}"

    SHELLCHECK_FAILED=0
    for file in "${SHELL_FILES[@]}"; do
        if [[ -f "$file" ]]; then
            # Only fail on warnings and errors, not info messages
            if ! shellcheck -S warning "$file"; then
                SHELLCHECK_FAILED=1
            fi
        fi
    done

    if [[ $SHELLCHECK_FAILED -eq 1 ]]; then
        echo -e "${RED}✗ Shellcheck failed${NC}"
        echo -e "${YELLOW}Fix shellcheck issues or use 'git commit --no-verify' to skip${NC}"
        exit 1
    fi

    echo -e "${GREEN}✓ Shellcheck passed${NC}"
else
    echo -e "${YELLOW}⚠️  Shellcheck not found (skipping)${NC}"
    echo -e "${YELLOW}   Install: brew install shellcheck${NC}"
fi

# Run basic syntax check
echo -e "${YELLOW}→ Checking bash syntax...${NC}"
for file in "${SHELL_FILES[@]}"; do
    if [[ -f "$file" ]]; then
        if ! bash -n "$file" 2>/dev/null; then
            echo -e "${RED}✗ Syntax error in $file${NC}"
            exit 1
        fi
    fi
done
echo -e "${GREEN}✓ Syntax check passed${NC}"

# Check that help file exists alongside main script
if [[ -f "git-worktree-utils.sh" ]] && [[ ! -f "git-worktree-utils-help.sh" ]]; then
    echo -e "${RED}✗ Missing git-worktree-utils-help.sh${NC}"
    exit 1
fi

echo -e "${GREEN}✓ Pre-commit checks passed${NC}"
exit 0
